<!DOCTYPE html>
<html>

<head>
    <title>Test Facebook Login vá»›i Cleanup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .contai // Auto-load message

        document.addEventListener('DOMContentLoaded', function() {
                console.log('ğŸ”§ Test page loaded - Sáºµn sÃ ng test LOGIN vá»›i Auto-Captcha Check + Cleanup');
                showResult('ğŸ”§ Sáºµn sÃ ng test LOGIN_FACEBOOK vá»›i Auto-Captcha Check + Cleanup', 'info');
            });
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .button {
            background: #4267B2;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px;
            transition: background 0.3s;
        }

        .button:hover {
            background: #365899;
        }

        .button.green {
            background: #42b883;
        }

        .button.green:hover {
            background: #369870;
        }

        .button.orange {
            background: #e67e22;
        }

        .button.orange:hover {
            background: #d35400;
        }

        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }

        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .step {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }

        h1 {
            color: #2c3e50;
        }

        h3 {
            color: #34495e;
            margin-top: 25px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”§ Test Facebook Login vá»›i Cleanup</h1>

        <div class="step">
            <h3>ğŸ§¹ BÆ°á»›c 1: Test Cleanup Functions</h3>
            <button class="button orange" onclick="testCleanupBeforeLogin()">ğŸ§¹ Test Cleanup HoÃ n Chá»‰nh</button>
            <button class="button" onclick="testCloseTabs()">ğŸ“‹ Test ÄÃ³ng Tab</button>
            <button class="button" onclick="testClearCookies()">ğŸª Test Clear Cookie</button>
            <button class="button orange" onclick="testCheckCaptcha()">ğŸ” Test Check Captcha</button>
            <button class="button orange" onclick="testCheckpointDetection()">âš ï¸ Test Checkpoint Detection</button>
            <button class="button green" onclick="testPerformance()">âš¡ Test Hiá»‡u Suáº¥t</button>
        </div>

        <div class="step">
            <h3>ğŸ“– BÆ°á»›c 2: Táº¡o Test Data</h3>
            <button class="button green" onclick="openFacebookTabs()">ğŸ“– Má»Ÿ Nhiá»u Tab Facebook</button>
            <button class="button green" onclick="createTestCookies()">ğŸª Táº¡o Test Cookie</button>
        </div>

        <div class="step">
            <h3>ğŸš€ BÆ°á»›c 3: Test Login Process (vá»›i Captcha Check)</h3>
            <p>âš ï¸ LÆ°u Ã½: Sáº½ tá»± Ä‘á»™ng kiá»ƒm tra captcha cookie vÃ  Ä‘á»£i 40s náº¿u cáº§n giáº£i captcha</p>
            <input type="email" id="testEmail" placeholder="Email Facebook"
                style="padding: 8px; margin: 5px; width: 200px;">
            <input type="password" id="testPassword" placeholder="Password"
                style="padding: 8px; margin: 5px; width: 200px;">
            <br>
            <button class="button" onclick="testLoginWithCleanup()" style="margin-top: 10px;">ğŸš€ Test LOGIN_FACEBOOK
                (Auto-Captcha + Cleanup)</button>
        </div>

        <div id="result"></div>

        <div class="step">
            <h3>ğŸ“‹ ThÃ´ng Tin Test:</h3>
            <ul>
                <li><strong>Cleanup HoÃ n Chá»‰nh:</strong> ÄÃ³ng tab + Clear cookie liÃªn tiáº¿p</li>
                <li><strong>AUTO-CAPTCHA:</strong> LOGIN_FACEBOOK tá»± Ä‘á»™ng kiá»ƒm tra captcha cookie vÃ  Ä‘á»£i 40s náº¿u cáº§n
                </li>
                <li><strong>AUTO-CLEANUP:</strong> Tá»± Ä‘á»™ng Ä‘Ã³ng tab cÅ© trÆ°á»›c khi login</li>
                <li><strong>CHECKPOINT DETECTION:</strong> PhÃ¡t hiá»‡n checkpoint qua cáº£ URL (/checkpoint/) vÃ  cookie</li>
                <li><strong>PERFORMANCE OPTIMIZED:</strong> CÃ¡c functions Ä‘Ã£ Ä‘Æ°á»£c tá»‘i Æ°u tá»‘c Ä‘á»™ (parallel processing)
                </li>
                <li><strong>Console Log:</strong> Má»Ÿ F12 Ä‘á»ƒ xem log chi tiáº¿t tá»«ng bÆ°á»›c</li>
                <li><strong>Test Flow:</strong> Check captcha â†’ Cleanup â†’ Login â†’ Auto cleanup sau login</li>
                <li><strong>Captcha Handling:</strong> Má»Ÿ tab Facebook vÃ  Ä‘á»£i 40s Ä‘á»ƒ ngÆ°á»i dÃ¹ng giáº£i captcha</li>
            </ul>
        </div>
    </div>

    <script>
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            resultDiv.innerHTML = `<div class="result ${className}">${message}</div>`;
        }

        function testCleanupBeforeLogin() {
            console.log('ğŸ§¹ Báº¯t Ä‘áº§u test cleanup hoÃ n chá»‰nh...');
            showResult('ğŸ”„ Äang test cleanup hoÃ n chá»‰nh (Ä‘Ã³ng tab + clear cookie)...', 'info');

            chrome.runtime.sendMessage({
                type: 'CLEANUP_BEFORE_LOGIN'
            }, function (response) {
                console.log('ğŸ“Š Káº¿t quáº£ cleanup:', response);

                if (response && response.success) {
                    showResult(`âœ… ${response.message}`, 'success');
                } else {
                    const errorMsg = response?.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';
                    showResult(`âŒ Lá»—i cleanup: ${errorMsg}`, 'error');
                }
            });
        }

        function testCloseTabs() {
            console.log('ğŸ“‹ Báº¯t Ä‘áº§u test Ä‘Ã³ng tab...');
            showResult('ğŸ”„ Äang test Ä‘Ã³ng tab Facebook...', 'info');

            chrome.runtime.sendMessage({
                type: 'CLOSE_FACEBOOK_TABS'
            }, function (response) {
                console.log('ğŸ“Š Káº¿t quáº£ Ä‘Ã³ng tab:', response);

                if (response && response.success) {
                    showResult(`âœ… ${response.message}`, 'success');
                } else {
                    const errorMsg = response?.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';
                    showResult(`âŒ Lá»—i: ${errorMsg}`, 'error');
                }
            });
        }

        function testCheckCaptcha() {
            console.log('ğŸ” Báº¯t Ä‘áº§u test kiá»ƒm tra captcha...');
            showResult('ğŸ”„ Äang kiá»ƒm tra cookie captcha Facebook...', 'info');

            chrome.runtime.sendMessage({
                type: 'CHECK_CAPTCHA_COOKIES'
            }, function (response) {
                console.log('ğŸ“Š Káº¿t quáº£ kiá»ƒm tra captcha:', response);

                if (response && response.success) {
                    if (response.data.hasCaptcha) {
                        showResult(`âš ï¸ ${response.message} - Cáº§n xá»­ lÃ½ captcha!`, 'warning');
                        console.log('ğŸ” Chi tiáº¿t captcha cookies:', response.data.captchaCookies);
                    } else {
                        showResult(`âœ… ${response.message}`, 'success');
                    }
                } else {
                    const errorMsg = response?.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';
                    showResult(`âŒ Lá»—i: ${errorMsg}`, 'error');
                }
            });
        }

        function testClearCookies() {
            console.log('ğŸª Báº¯t Ä‘áº§u test clear cookie...');
            showResult('ğŸ”„ Äang test clear cookie Facebook...', 'info');

            chrome.runtime.sendMessage({
                type: 'CLEAR_FACEBOOK_COOKIES'
            }, function (response) {
                console.log('ğŸ“Š Káº¿t quáº£ clear cookie:', response);

                if (response && response.success) {
                    showResult(`âœ… ${response.message}`, 'success');
                } else {
                    const errorMsg = response?.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';
                    showResult(`âŒ Lá»—i: ${errorMsg}`, 'error');
                }
            });
        }

        function openFacebookTabs() {
            console.log('ğŸ“– Táº¡o nhiá»u tab Facebook test...');
            showResult('ğŸ”„ Äang táº¡o nhiá»u tab Facebook test...', 'info');

            const urls = [
                'https://www.facebook.com',
                'https://m.facebook.com',
                'https://web.facebook.com/login'
            ];

            let created = 0;
            urls.forEach((url, index) => {
                setTimeout(() => {
                    chrome.tabs.create({
                        url: url,
                        active: false
                    }, function (tab) {
                        created++;
                        console.log(`ğŸ“– ÄÃ£ táº¡o tab ${created}: ${tab.id} - ${url}`);

                        if (created === urls.length) {
                            showResult(`âœ… ÄÃ£ táº¡o ${created} tab Facebook test`, 'success');
                        }
                    });
                }, index * 500); // Delay giá»¯a cÃ¡c tab
            });
        }

        function createTestCookies() {
            showResult('ğŸª Táº¡o test cookie (cáº§n truy cáº­p Facebook trÆ°á»›c)', 'warning');
            chrome.tabs.create({url: 'https://www.facebook.com'});
        }

        function testLoginWithCleanup() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            if (!email || !password) {
                showResult('âŒ Vui lÃ²ng nháº­p email vÃ  password Ä‘á»ƒ test', 'error');
                return;
            }

            console.log('ğŸš€ Báº¯t Ä‘áº§u test LOGIN_FACEBOOK vá»›i auto-captcha check...');
            showResult('ğŸ”„ Äang test LOGIN_FACEBOOK vá»›i auto-captcha check + cleanup...', 'info');

            // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o vá» cÃ¡c bÆ°á»›c sáº½ thá»±c hiá»‡n
            setTimeout(() => {
                showResult('ğŸ“‹ CÃ¡c bÆ°á»›c: 1ï¸âƒ£ ÄÃ³ng tab cÅ© â†’ 2ï¸âƒ£ Check captcha â†’ 3ï¸âƒ£ Login â†’ 4ï¸âƒ£ Auto cleanup', 'warning');
            }, 1000);

            chrome.runtime.sendMessage({
                type: 'LOGIN_FACEBOOK',
                email: email,
                password: password
            }, function (response) {
                console.log('ğŸ“Š Káº¿t quáº£ LOGIN_FACEBOOK:', response);

                if (response && response.success) {
                    let message = `âœ… LOGIN_FACEBOOK hoÃ n táº¥t!`;
                    if (response.isLoginSuccess) {
                        message += ` ğŸ‰ ÄÄƒng nháº­p thÃ nh cÃ´ng!`;
                    } else if (response.isCheckPointAccount) {
                        message += ` âš ï¸ TÃ i khoáº£n checkpoint!`;
                    } else {
                        message += ` âŒ ÄÄƒng nháº­p tháº¥t báº¡i!`;
                    }
                    showResult(message, response.isLoginSuccess ? 'success' : 'warning');
                } else {
                    const errorMsg = response?.error || response?.message || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';
                    showResult(`âŒ Lá»—i LOGIN_FACEBOOK: ${errorMsg}`, 'error');
                }
            });
        }

        function testPerformance() {
            console.log('âš¡ Báº¯t Ä‘áº§u test hiá»‡u suáº¥t...');
            showResult('ğŸ”„ Äang test hiá»‡u suáº¥t cÃ¡c functions...', 'info');

            const startTime = performance.now();

            // Test 1: Clear cookies speed
            const clearStart = performance.now();
            chrome.runtime.sendMessage({
                type: 'CLEAR_FACEBOOK_COOKIES'
            }, function (response) {
                const clearTime = performance.now() - clearStart;
                console.log(`ğŸª Clear cookies took: ${clearTime.toFixed(2)}ms`);

                // Test 2: Close tabs speed  
                const closeStart = performance.now();
                chrome.runtime.sendMessage({
                    type: 'CLOSE_FACEBOOK_TABS'
                }, function (response) {
                    const closeTime = performance.now() - closeStart;
                    console.log(`ğŸ“‹ Close tabs took: ${closeTime.toFixed(2)}ms`);

                    // Test 3: Check captcha speed
                    const captchaStart = performance.now();
                    chrome.runtime.sendMessage({
                        type: 'CHECK_CAPTCHA_COOKIES'
                    }, function (response) {
                        const captchaTime = performance.now() - captchaStart;
                        console.log(`ğŸ” Check captcha took: ${captchaTime.toFixed(2)}ms`);

                        const totalTime = performance.now() - startTime;

                        const resultMsg = `âš¡ Káº¿t quáº£ hiá»‡u suáº¥t:
                        â€¢ Clear Cookies: ${clearTime.toFixed(2)}ms
                        â€¢ Close Tabs: ${closeTime.toFixed(2)}ms  
                        â€¢ Check Captcha: ${captchaTime.toFixed(2)}ms
                        â€¢ Tá»•ng thá»i gian: ${totalTime.toFixed(2)}ms`;

                        showResult(resultMsg, 'success');
                        console.log('âš¡ Performance test completed:', {
                            clearCookies: clearTime,
                            closeTabs: closeTime,
                            checkCaptcha: captchaTime,
                            total: totalTime
                        });
                    });
                });
            });
        }

        function testCheckpointDetection() {
            console.log('âš ï¸ Báº¯t Ä‘áº§u test phÃ¡t hiá»‡n checkpoint...');
            showResult('ğŸ”„ Äang test phÃ¡t hiá»‡n checkpoint (URL + Cookie)...', 'info');

            // Táº¡o tab Facebook checkpoint Ä‘á»ƒ test
            chrome.tabs.create({
                url: 'https://www.facebook.com/checkpoint/',
                active: false
            }, function (tab) {
                console.log(`ğŸ“– ÄÃ£ táº¡o tab checkpoint: ${tab.id}`);

                // Äá»£i tab load vÃ  test checkpoint detection
                setTimeout(() => {
                    chrome.runtime.sendMessage({
                        type: 'CHECK_LOGIN_STATUS',
                        email: 'test@checkpoint.com',
                        tabId: tab.id
                    }, function (response) {
                        console.log('ğŸ“Š Káº¿t quáº£ checkpoint detection:', response);

                        if (response && response.success) {
                            if (response.isCheckPointAccount) {
                                showResult(`âœ… Checkpoint detected thÃ nh cÃ´ng! ${response.message}`, 'warning');
                            } else {
                                showResult(`âš ï¸ KhÃ´ng phÃ¡t hiá»‡n checkpoint - cÃ³ thá»ƒ cáº§n cookie checkpoint`, 'warning');
                            }
                        } else {
                            const errorMsg = response?.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh';
                            showResult(`âŒ Lá»—i: ${errorMsg}`, 'error');
                        }

                        // ÄÃ³ng tab test sau 3 giÃ¢y
                        setTimeout(() => {
                            chrome.tabs.remove(tab.id);
                            console.log('ğŸ—‘ï¸ ÄÃ£ Ä‘Ã³ng tab checkpoint test');
                        }, 3000);
                    });
                }, 2000); // Äá»£i 2 giÃ¢y Ä‘á»ƒ tab load
            });
        }

        // Auto-load message
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸ”§ Test page loaded - Sáºµn sÃ ng test LOGIN vá»›i Auto-Captcha Check + Checkpoint Detection');
            showResult('ğŸ”§ Sáºµn sÃ ng test LOGIN_FACEBOOK vá»›i Auto-Captcha Check + Cleanup', 'info');
        });
    </script>
</body>

</html>